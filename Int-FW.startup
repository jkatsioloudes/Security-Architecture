# Internal Firewall is responsible to filter all the
# inside traffic, allow internet access and provide
# access to the DMZ components.

ifconfig eth0 10.0.3.1/30
ifconfig eth1 10.0.1.1/30
ifconfig eth2 10.0.0.2/30
ifconfig eth3 10.0.2.1/30
ifconfig eth4 10.0.10.1/30
ifconfig eth5 10.0.8.1/30


# Adding networks that are accessible through
# directly connected gateways.

# OpenVPN Server accessible through the DMZ Gateway VPN.
route add -net 172.16.1.0/30 gw 10.0.1.2

# Mail Server accessible through the DMZ Gateway Mail.
route add -net 192.168.1.0/30 gw 10.0.2.2

# Attaches GW-WBS.
route add -net 10.0.4.0/30 gw 10.0.3.2

# Attaches GW-WMG.
route add -net 10.0.6.0/30 gw 10.0.3.2

# Attaches WBS LAN.
route add -net 10.0.5.0/24 gw 10.0.3.2

# Attaches WMG LAN.
route add -net 10.0.7.0/24 gw 10.0.3.2

# Attaches Internal Servers LAN.
route add -net 10.0.9.0/29 gw 10.0.8.2

# Attaches LDAP LAN.
route add -net 10.0.11.0/30 gw 10.0.10.2

# External Firewall as Default for the rest.
route add default gw 10.0.0.1


# Firewall Rules for the Internal Firewall

# RULE 1 -- Default Policies are set to DROP towards whitelisting.

iptables -t filter -P INPUT DROP
iptables -t filter -P OUTPUT DROP
iptables -t filter -P FORWARD DROP


# RULE 2 -- DNAT for DMZ's OpenVPN Server alongside FORWARD chain stateful rules.

# Only accepts connections from WBS and WMG IP range to follow the Least Privilege Principle.

iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 1194 -m comment --comment "Routes incoming packets addressed to the VPN" -j DNAT --to-destination 172.16.1.2

iptables -A FORWARD -i eth0 -o eth1 -s 10.0.5.0/24 -p tcp --syn --dport 1194 -m conntrack --ctstate NEW -m comment --comment "Only accept VPN connection initiations from the WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth1 -s 10.0.7.0/24 -p tcp --syn --dport 1194 -m conntrack --ctstate NEW -m comment --comment "Only accept VPN connection initiations from the WMG LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth1 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful VPN connection" -j ACCEPT

iptables -A FORWARD -i eth1 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful VPN connection" -j ACCEPT


# RULE 3 -- DNAT for DMZ's Mail Server alongside FORWARD chain stateful rules.

iptables -t nat -A PREROUTING -i eth0 -p tcp --match multiport --dports 25,587,993 -m comment --comment "Routes incoming packets addressed to the Mail Server" -j DNAT --to-destination 192.168.1.2

iptables -A FORWARD -i eth0 -o eth3 -s 10.0.5.0/24 -p tcp --syn --match multiport --dports 25,587,993 -m conntrack --ctstate NEW -m comment --comment "Accept new Mail connection initiation from WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth3 -s 10.0.7.0/24 -p tcp --syn --match multiport --dports 25,587,993 -m conntrack --ctstate NEW -m comment --comment "Accept new Mail connection initiation from WMG LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth3 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful Mail connection" -j ACCEPT

iptables -A FORWARD -i eth3 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful Mail connection" -j ACCEPT


# RULE 4 -- DNAT for Internal LDAP Server alongside FORWARD chain stateful rules for both UDP and TCP.

# UDP is implemented in a bidirectional manner due to the nature of LDAP (Reference: https://serverfault.com/questions/828769/need-iptables-port-forwarding-for-bidirectional-udp)

iptables -t nat -A PREROUTING -i eth0 -p udp --dport 389 -m comment --comment "Makes a UDP connection behave like a TCP with bidirectional capabilities" -j MARK --set-mark 0x1

iptables -t nat -A PREROUTING -p udp -m mark --mark 0x1 -m comment --comment "Routes incoming UDP packets addressed to the internal LDAP Server" -j DNAT --to-destination 10.0.11.2:389

iptables -A FORWARD -i eth0 -o eth4 -s 10.0.5.0/24 -p udp --dport 389 -m comment --comment "Accept new UDP LDAP connection from WMB LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth4 -s 10.0.7.0/24 -p udp --dport 389 -m comment --comment "Accept new UDP LDAP connection from WMG LAN" -j ACCEPT

# TCP follows.

iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 389 -m comment --comment "Routes incoming TCP packets addressed to the internal LDAP Server" -j DNAT --to-destination 10.0.11.2

iptables -A FORWARD -i eth0 -o eth4 -s 10.0.5.0/24 -p tcp --syn --dport 389 -m conntrack --ctstate NEW -m comment --comment "Accept new TCP LDAP connection initiations from WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth4 -s 10.0.7.0/24 -p tcp --syn --dport 389 -m conntrack --ctstate NEW -m comment --comment "Accept new TCP LDAP connection initiations from WMG LAN" -j ACCEPT

# Established, Related 

iptables -A FORWARD -i eth0 -o eth4 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful LDAP connection" -j ACCEPT

iptables -A FORWARD -i eth4 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful LDAP connection" -j ACCEPT


# RULE 5 -- Internal users should connect to websites residing in the public Internet (Ext-WWW).

# This is achieved by forwarding all port 80 packets towards the external firewall.

iptables -A FORWARD -i eth0 -o eth2 -s 10.0.5.0/24 -p tcp --syn --dport 80 -m conntrack --ctstate NEW -m comment --comment "External WWW Access to WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth2 -s 10.0.7.0/24 -p tcp --syn --dport 80 -m conntrack --ctstate NEW -m comment --comment "External WWW Access to WMG LAN" -j ACCEPT

# The following two rules are also used for RULE 7 to make the connection stateful.

iptables -A FORWARD -i eth0 -o eth2 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful WWW Connection" -j ACCEPT

iptables -A FORWARD -i eth2 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful WWW Connection" -j ACCEPT


# RULE 6 -- Internal users should connect to internal websites via internal WWW (Int-WWW).

iptables -A FORWARD -i eth0 -o eth5 -s 10.0.5.0/24 -p tcp --syn --dport 80 -m conntrack --ctstate NEW -m comment --comment "Internal WWW Access to WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth5 -s 10.0.7.0/24 -p tcp --syn --dport 80 -m conntrack --ctstate NEW -m comment --comment "Internal WWW Access to WMG LAN" -j ACCEPT

# The following two rules are also used for RULE 8 to make the connection stateful.

iptables -A FORWARD -i eth0 -o eth5 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful WWW Connection" -j ACCEPT

iptables -A FORWARD -i eth5 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful WWW Connection" -j ACCEPT


# RULE 7 -- Internal users should connect to External DNS that resides in the public Internet (Ext-DNS).

iptables -A FORWARD -i eth0 -o eth2 -s 10.0.5.0/24 -p udp --dport 53 -m comment --comment "External DNS Access from WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth2 -s 10.0.7.0/24 -p udp --dport 53 -m comment --comment "External DNS Access from WMG LAN" -j ACCEPT


# RULE 8 -- Internal users should connect to Internal DNS (Int-DNS).

iptables -A FORWARD -i eth0 -o eth5 -s 10.0.5.0/24 -p udp --dport 53 -m comment --comment "Internal DNS Access from WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth5 -s 10.0.7.0/24 -p udp --dport 53 -m comment --comment "Internal DNS Access from WMG LAN" -j ACCEPT


# RULE 9 -- Internal users should be able to ping the DMZ and internal servers and not the other way around.

iptables -A FORWARD -i eth0 -p icmp --icmp-type echo-request -j ACCEPT

iptables -A FORWARD ! -i eth0 -p icmp --icmp-type echo-reply -j ACCEPT
