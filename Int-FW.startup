# Internal Firewall is responsible to filter all the
# inside traffic, allow internet access and provide
# access to the DMZ components.

ifconfig eth0 10.0.3.1/30
ifconfig eth1 10.0.1.1/30
ifconfig eth2 10.0.0.2/30
ifconfig eth3 10.0.2.1/30
ifconfig eth4 10.0.10.1/30
ifconfig eth5 10.0.8.1/30


# Adding networks that are accessible through
# directly connected gateways.

# OpenVPN Server accessible through the DMZ Gateway VPN.
route add -net 172.16.1.0/30 gw 10.0.1.2

# Mail Server accessible through the DMZ Gateway Mail.
route add -net 192.168.1.0/30 gw 10.0.2.2

# Attaches GW-WBS.
route add -net 10.0.4.0/30 gw 10.0.3.2

# Attaches GW-WMG.
route add -net 10.0.6.0/30 gw 10.0.3.2

# Attaches WBS LAN.
route add -net 10.0.5.0/24 gw 10.0.3.2

# Attaches WMG LAN.
route add -net 10.0.7.0/24 gw 10.0.3.2

# Attaches Internal Servers LAN.
route add -net 10.0.9.0/29 gw 10.0.8.2

# Attaches LDAP LAN.
route add -net 10.0.11.0/30 gw 10.0.10.2

# External Firewall as Default for the rest.
route add default gw 10.0.0.1


# Firewall Rules for the Internal Firewall

# RULE 1 -- Default Policies are set to DROP towards whitelisting.

iptables -t filter -P INPUT DROP
iptables -t filter -P OUTPUT DROP
iptables -t filter -P FORWARD DROP


# RULE 2 -- DNAT for DMZ's OpenVPN Server alongside FORWARD chain stateful rules.

# Only accepts connections from WBS and WMG IP range to follow the Least Privilege Principle.

iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 1194 -m comment --comment "Routes incoming packets addressed to the VPN" -j DNAT --to-destination 172.16.1.2

iptables -A FORWARD -i eth0 -o eth1 -s 10.0.5.0/24 -p tcp --syn --dport 1194 -m conntrack --ctstate NEW -m comment --comment "Only accept VPN connection initiations from the WBS LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth1 -s 10.0.7.0/24 -p tcp --syn --dport 1194 -m conntrack --ctstate NEW -m comment --comment "Only accept VPN connection initiations from the WMG LAN" -j ACCEPT

iptables -A FORWARD -i eth0 -o eth1 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful VPN connection" -j ACCEPT

iptables -A FORWARD -i eth1 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "Stateful VPN connection" -j ACCEPT

